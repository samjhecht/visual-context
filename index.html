<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visual Context - Claude Code Context Visualizer</title>
  <link rel="stylesheet" href="src/styles/variables.css">
  <link rel="stylesheet" href="src/styles/base.css">
  <link rel="stylesheet" href="src/styles/components.css">
</head>
<body>
  <header class="header">
    <div class="header-brand">
      <div class="header-logo"></div>
      <h1 class="header-title">Visual Context</h1>
      <span class="header-version">v0.1.0</span>
    </div>
    <div class="filters">
      <div class="filter-group">
        <label class="filter-label">Working Directory</label>
        <select id="cwd-select" class="filter-select">
          <option value="">Select a project...</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">Agent Profile</label>
        <select id="agent-select" class="filter-select">
          <option value="default">Default</option>
        </select>
      </div>
    </div>
  </header>

  <main class="main">
    <div class="toolbar">
      <button class="toolbar-btn" onclick="expandAll()">Expand All</button>
      <button class="toolbar-btn" onclick="collapseAll()">Collapse All</button>
      <button class="toolbar-btn" onclick="refreshData()">Refresh</button>
    </div>
    <div id="layers-container">
      <div class="loading">
        <div class="loading-spinner"></div>
      </div>
    </div>
  </main>

  <script type="module">
    import { ContextLoader } from './src/data/context-loader.js';
    import { LayerRenderer } from './src/components/layer-renderer.js';

    // Initialize
    const container = document.getElementById('layers-container');
    const cwdSelect = document.getElementById('cwd-select');
    const agentSelect = document.getElementById('agent-select');

    const loader = new ContextLoader();
    const renderer = new LayerRenderer(container);

    // Global functions for onclick handlers
    window.toggleLayer = (id) => renderer.toggleLayer(id);
    window.expandAll = () => renderer.expandAll();
    window.collapseAll = () => renderer.collapseAll();

    window.expandFileRef = async (element, filename) => {
      const existing = element.parentElement.querySelector('.file-ref-content');
      if (existing) {
        existing.remove();
        return;
      }

      const content = document.createElement('div');
      content.className = 'file-ref-content';
      content.textContent = `Loading ${filename}...`;
      element.parentElement.insertBefore(content, element.nextSibling);

      // In a real implementation, this would load the file
      // For now, show a placeholder
      setTimeout(() => {
        content.textContent = `[File content for ${filename} would be loaded here]`;
      }, 300);
    };

    window.refreshData = () => loadContextData();

    // Sample data for demonstration (when not loading from scan script)
    const SAMPLE_DATA = {
      metadata: {
        scannedAt: new Date().toISOString(),
        targetCwd: '/Users/juliushecht/medb',
        claudeDir: '/Users/juliushecht/.claude'
      },
      systemPrompt: {
        exists: true,
        path: '~/.claude-config/system_prompt.md',
        content: `# Claude Code System Prompt

This is the system prompt that Claude Code sends to the model at the start of each session.

---

You are Claude Code, Anthropic's official CLI for Claude.
You are an interactive CLI tool that helps users with software engineering tasks. Use the instructions below and the tools available to you to assist the user.

IMPORTANT: Assist with authorized security testing, defensive security, CTF challenges, and educational contexts. Refuse requests for destructive techniques, DoS attacks, mass targeting, supply chain compromise, or detection evasion for malicious purposes. Dual-use security tools (C2 frameworks, credential testing, exploit development) require clear authorization context: pentesting engagements, CTF competitions, security research, or defensive use cases.

IMPORTANT: You must NEVER generate or guess URLs for the user unless you are confident that the URLs are for helping the user with programming. You may use URLs provided by the user in their messages or local files.

If the user asks for help or wants to give feedback inform them of the following:
- /help: Get help with using Claude Code
- To give feedback, users should report the issue at https://github.com/anthropics/claude-code/issues

# Looking up your own documentation:

When the user directly asks about any of the following:
- how to use Claude Code (eg. "can Claude Code do...", "does Claude Code have...")
- what you're able to do as Claude Code in second person (eg. "are you able...", "can you do...")
- about how they might do something with Claude Code (eg. "how do I...", "how can I...")
- how to use a specific Claude Code feature (eg. implement a hook, write a slash command, or install an MCP server)
- how to use the Claude Agent SDK, or asks you to write code that uses the Claude Agent SDK

Use the Task tool with subagent_type='claude-code-guide' to get accurate information from the official Claude Code and Claude Agent SDK documentation.

# Tone and style
- Only use emojis if the user explicitly requests it. Avoid using emojis in all communication unless asked.
- Your output will be displayed on a command line interface. Your responses should be short and concise. You can use Github-flavored markdown for formatting, and will be rendered in a monospace font using the CommonMark specification.
- Output text to communicate with the user; all text you output outside of tool use is displayed to the user. Only use tools to complete tasks. Never use tools like Bash or code comments as means to communicate with the user during the session.
- NEVER create files unless they're absolutely necessary for achieving your goal. ALWAYS prefer editing an existing file to creating a new one. This includes markdown files.

# Professional objectivity
Prioritize technical accuracy and truthfulness over validating the user's beliefs. Focus on facts and problem-solving, providing direct, objective technical info without any unnecessary superlatives, praise, or emotional validation. It is best for the user if Claude honestly applies the same rigorous standards to all ideas and disagrees when necessary, even if it may not be what the user wants to hear. Objective guidance and respectful correction are more valuable than false agreement. Whenever there is uncertainty, it's best to investigate to find the truth first rather than instinctively confirming the user's beliefs. Avoid using over-the-top validation or excessive praise when responding to users such as "You're absolutely right" or similar phrases.

# Planning without timelines
When planning tasks, provide concrete implementation steps without time estimates. Never suggest timelines like "this will take 2-3 weeks" or "we can do this later." Focus on what needs to be done, not when. Break work into actionable steps and let users decide scheduling.

# Task Management
You have access to the TodoWrite tools to help you manage and plan tasks. Use these tools VERY frequently to ensure that you are tracking your tasks and giving the user visibility into your progress.
These tools are also EXTREMELY helpful for planning tasks, and for breaking down larger complex tasks into smaller steps. If you do not use this tool when planning, you may forget to do important tasks - and that is unacceptable.

It is critical that you mark todos as completed as soon as you are done with a task. Do not batch up multiple tasks before marking them as completed.

# Tool usage policy
- When doing file search, prefer to use the Task tool in order to reduce context usage.
- You should proactively use the Task tool with specialized agents when the task at hand matches the agent's description.
- A custom slash command is a user-defined operation that starts with /, like /commit. When executed, the slash command gets expanded to a full prompt. Use the Skill tool to execute them.
- You can call multiple tools in a single response. If you intend to call multiple tools and there are no dependencies between them, make all independent tool calls in parallel.
- Use specialized tools instead of bash commands when possible. For file operations, use dedicated tools: Read for reading files, Edit for editing, and Write for creating files.

# Code References
When referencing specific functions or pieces of code include the pattern \`file_path:line_number\` to allow the user to easily navigate to the source code location.`
      },
      globalMemory: {
        exists: true,
        path: '/Users/juliushecht/.claude/CLAUDE.md',
        content: `- **NO EMOJIS**: Do not use emojis in code, documentation, README files, UI text, commit messages, or any other written output unless explicitly requested.

- never say something is production-ready unless explicitly asked

- If the project you're working on has tests, always run them yourself before telling the user that things are ready to go.

## Process Management - CRITICAL

**NEVER kill processes that use Electron generically** - this kills VSCode and other unrelated apps.

## File Organization Guidelines

**IMPORTANT: When creating analysis, documentation, or reference files, DO NOT create them at project root.**

Use these directories for different file types:

**\`memos/\` - Reference Material & Lessons Learned**
- Root cause analyses (RCA-*.md)
- Post-mortems and incident reports
- Technical investigations

**\`docs/\` - User-Facing Documentation**
- Product documentation
- User guides and tutorials

**\`devops/docs/\` - Developer/Maintainer Documentation**
- Architecture decision records (ADR)
- Deployment procedures`
      },
      projectMemory: {
        exists: false,
        path: '/Users/juliushecht/medb/CLAUDE.md'
      },
      settings: {
        hooks: {
          SessionStart: []
        },
        enabledPlugins: {
          'wrangler@samjhecht-plugins': true,
          'medb-claude-code-plugin@medb-plugins': true
        },
        mcpServers: {
          'chrome-devtools': {
            command: 'npx',
            args: ['-y', 'chrome-devtools-mcp@latest']
          },
          'vercel': {
            type: 'http',
            url: 'https://mcp.vercel.com/'
          }
        }
      },
      installedPlugins: {
        version: 2,
        plugins: {
          'wrangler@samjhecht-plugins': [{
            version: '1.2.0',
            installPath: '/Users/juliushecht/.claude/plugins/cache/samjhecht-plugins/wrangler/1.2.0'
          }],
          'medb-claude-code-plugin@medb-plugins': [{
            version: '1.0.0',
            installPath: '/Users/juliushecht/.claude/plugins/cache/medb-plugins/medb-claude-code-plugin/1.0.0'
          }]
        }
      },
      knownProjects: [
        { path: '/Users/juliushecht/medb', lastUsed: Date.now(), hasClaudeMd: false },
        { path: '/Users/juliushecht/medb/projects/wrangler', lastUsed: Date.now() - 10000, hasClaudeMd: true },
        { path: '/Users/juliushecht/medb/code/wrangler', lastUsed: 0, hasClaudeMd: true }
      ],
      outputStyles: {
        user: [],
        project: [],
        activeName: 'coordinator',
        all: {
          'coordinator': {
            id: 'coordinator',
            name: 'Coordinator',
            path: '~/.claude/output-styles/coordinator.md',
            source: 'user',
            content: `---
name: Coordinator
description: Delegates tasks to specialized subagents
keep-coding-instructions: true
---

You are a task coordinator. Your role is to orchestrate work through specialized subagents rather than implementing directly.

When the user mentions multiple tasks or requests work, delegate to background subagents using the Task tool.`
          },
          'concise': {
            id: 'concise',
            name: 'Concise',
            path: '~/.claude/output-styles/concise.md',
            source: 'user',
            content: `---
name: Concise
description: Brief, to-the-point responses
keep-coding-instructions: false
---

You are concise Claude. Provide brief, direct answers without unnecessary elaboration.

- Keep responses short
- Get to the point quickly
- Avoid verbose explanations`
          }
        }
      }
    };

    // Populate project selector
    function populateProjects(projects, currentCwd = null) {
      cwdSelect.innerHTML = '<option value="">Select a project...</option>';

      // Projects are already sorted by lastUsed (most recent first)
      projects.forEach((proj, index) => {
        const option = document.createElement('option');
        const path = proj.path || proj.decoded; // Handle both formats
        option.value = path;

        // Show relative path for cleaner display
        let displayPath = path;
        if (path.startsWith('/Users/')) {
          displayPath = '~' + path.slice(path.indexOf('/', 7));
        }

        // Add indicators
        const indicators = [];
        if (proj.hasClaudeMd) indicators.push('[M]'); // Has CLAUDE.md
        if (index === 0 && proj.lastUsed) indicators.push('[Recent]');

        option.textContent = indicators.length
          ? `${displayPath} ${indicators.join(' ')}`
          : displayPath;

        cwdSelect.appendChild(option);
      });

      // Auto-select: current cwd > most recent > first with CLAUDE.md
      if (currentCwd) {
        cwdSelect.value = currentCwd;
      } else if (projects.length > 0) {
        const mostRecent = projects[0];
        if (mostRecent.lastUsed) {
          cwdSelect.value = mostRecent.path || mostRecent.decoded;
        }
      }
    }

    // Populate agent profile (output styles) selector
    function populateAgentProfiles() {
      agentSelect.innerHTML = '';

      // Add "None" option (base system prompt)
      const noneOption = document.createElement('option');
      noneOption.value = '';
      noneOption.textContent = 'None (Base System Prompt)';
      agentSelect.appendChild(noneOption);

      // Get all available output styles
      const styles = loader.getAvailableOutputStyles();
      const activeStyleName = loader.getActiveOutputStyleName();

      // Sort styles alphabetically
      styles.sort((a, b) => a.name.localeCompare(b.name));

      styles.forEach(style => {
        const option = document.createElement('option');
        option.value = style.id;

        // Extract display name from frontmatter or use filename
        const metadata = loader.extractOutputStyleMetadata(style.content);
        const displayName = metadata.name || style.name;

        // Add source indicator
        const sourceIndicator = style.source === 'project' ? ' [Project]' : '';
        option.textContent = displayName + sourceIndicator;

        agentSelect.appendChild(option);
      });

      // Set the active style if any
      if (activeStyleName) {
        agentSelect.value = activeStyleName;
      } else {
        agentSelect.value = '';
      }
    }

    // Load context data
    async function loadContextData(cwd = null) {
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

      try {
        // Try to load from context.json if it exists, otherwise use sample data
        let data;
        let dataSource = 'sample';
        try {
          const response = await fetch('context.json');
          if (response.ok) {
            data = await response.json();
            dataSource = 'context.json';
          } else {
            throw new Error('Not found');
          }
        } catch (fetchError) {
          // Use sample data for demonstration
          // Note: fetch() often fails on file:// URLs due to CORS
          console.log('Using sample data (fetch failed:', fetchError.message, ')');
          console.log('Tip: Run "python3 -m http.server 8080" and open http://localhost:8080');
          data = SAMPLE_DATA;
        }
        console.log('Data source:', dataSource);

        const normalized = loader.loadFromData(data);
        const currentCwd = data.metadata?.targetCwd || null;
        populateProjects(data.knownProjects || SAMPLE_DATA.knownProjects, currentCwd);
        populateAgentProfiles();
        renderer.render(normalized.layers);
      } catch (error) {
        console.error('Failed to load context:', error);
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-title">Failed to load context</div>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    // Event listeners
    cwdSelect.addEventListener('change', (e) => {
      if (e.target.value) {
        loadContextData(e.target.value);
      }
    });

    agentSelect.addEventListener('change', (e) => {
      // Recompile the system prompt with the selected output style
      const selectedStyleId = e.target.value || null;
      const normalized = loader.recompileWithOutputStyle(selectedStyleId);
      if (normalized) {
        renderer.render(normalized.layers);
      }
    });

    // Initial load
    loadContextData();
  </script>
</body>
</html>
